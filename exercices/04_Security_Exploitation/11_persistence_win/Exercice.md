⚠️ AVERTISSEMENT STRICT
Techniques de malware development. Usage éducatif uniquement.


### EXERCICES - MODULE 32 : WINDOWS PERSISTENCE

[ ] 1. REGISTRY RUN KEYS COMPLETS
Implémenter tous Registry autorun locations :
- HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run
- HKCU\\...\\RunOnce
- HKLM\\...\\Run (nécessite admin)
- HKLM\\...\\RunOnceEx
- HKCU\\...\\Explorer\\User Shell Folders
- Winlogon registry keys

Référence : Autoruns locations (Sysinternals)

[ ] 2. SCHEDULED TASKS VIA COM API
Utiliser Task Scheduler COM au lieu de schtasks.exe :
- ITaskService interface
- Créer tâche déclenchée par logon/boot
- Run as SYSTEM si privilèges
- Hidden task (pas visible Task Scheduler GUI)
- Persistence quotidienne ou au boot

Référence : MSDN Task Scheduler 2.0

[ ] 3. WINDOWS SERVICE COMPLET
Service malveillant fonctionnel :
- ServiceMain et ServiceCtrlHandler
- Start/Stop/Pause controls
- Auto-restart si crash
- Run as SYSTEM account
- Description légitime (masquerade)
- Service dependencies

Référence : Windows Service development

[ ] 4. WMI EVENT SUBSCRIPTIONS
Permanent WMI consumers :
- EventFilter (trigger condition)
- CommandLineEventConsumer (exécution)
- ActiveScriptEventConsumer (VBScript/JScript)
- FilterToConsumerBinding
- Déclencheurs: time-based, process start, etc.

Référence : WMI persistence (ATT&CK T1546.003)

[ ] 5. DLL HIJACKING
Trouver et exploiter DLL hijack :
- Scan apps pour missing DLLs (Process Monitor)
- DLL search order exploitation
- Phantom DLL hijacking
- DLL side-loading
- Proxy DLL forwarding (load original + malicious)

Référence : DLL hijacking techniques

[ ] 6. COM HIJACKING
Détourner COM objects :
- Trouver CLSIDs auto-launched (Explorer, Office)
- Registry TreatAs ou InprocServer32 modification
- Hijack COM object utilisé au boot
- Load original COM + inject malicious

Référence : COM hijacking (ATT&CK T1546.015)

[ ] 7. PRINT MONITORS / PORT MONITORS
Persistence via print spooler :
- AddMonitor API
- Monitor DLL chargée par spoolsv.exe (SYSTEM)
- Très furtive, rarement scannée
- Nécessite admin
- Survit à reimaging parfois (persistent entre OS)

Référence : Print monitor persistence

[ ] 8. MULTI-METHOD REDUNDANCY
Implémenter 5+ méthodes simultanées :
- Registry Run + Scheduled Task + Service
- Si une détectée/supprimée, autres restaurent
- Watchdog threads vérifient persistence
- Auto-repair si mécanisme supprimé
- Logs pour tracking détections

Référence : APT persistence redundancy (Duqu, Stuxnet)


### NOTES :
- Registry = le plus détectable (Autoruns scan)
- WMI = très furtif mais nécessite admin
- Scheduled Tasks = bon compromis détection/efficacité
- Services = très visible (services.msc)
- DLL/COM hijacking = furtif mais complexe
- Combiner multiples pour redondance
- Tester détection avec Autoruns, Process Monitor

