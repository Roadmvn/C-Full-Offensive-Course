# Cours : Heap Exploitation

## 1. Introduction - Exploiter le Gestionnaire de Mémoire

Le **Heap** (tas) est géré par un allocateur (malloc/free). Exploiter le Heap signifie **abuser des métadonnées** que l'allocateur utilise pour gérer la mémoire libre.

## 2. Structure Interne du Heap

### 2.1 Métadonnées des Chunks

```ascii
CHUNK ALLOUÉ (malloc) :

┌──────────────────────────────────┐
│  METADATA (Header)               │  8-16 bytes
│  ├─ Taille du chunk              │
│  ├─ Flags (in_use, prev_size)    │
│  └─ Checksum (optionnel)         │
├──────────────────────────────────┤
│  USER DATA                       │  Ce que vous utilisez
│  (ce que malloc retourne)        │
│  ...                             │
└──────────────────────────────────┘

Le pointeur retourné par malloc()
pointe APRÈS les métadonnées
```

### 2.2 Free List (Liste des Blocs Libres)

```ascii
APRÈS plusieurs malloc/free :

┌─────┬─────┬─────┬─────┬─────┐
│USED │FREE │USED │FREE │USED │
└─────┴──┬──┴─────┴──┬──┴─────┘
         │           │
         └─────┬─────┘
               ↓
       Liste chaînée des blocs libres
```

## 3. Vulnérabilités du Heap

### 3.1 Use-After-Free

```ascii
ptr = malloc(100);
free(ptr);
*ptr = 42;  // ❌ Écriture dans mémoire libérée

┌──────────────┐
│ LIBÉRÉ       │ ← Peut avoir été réalloué
│ (réutilisé)  │    à un autre usage
└──────────────┘
     ↑
Écriture ici = corruption !
```

### 3.2 Double Free

```ascii
ptr = malloc(100);
free(ptr);
free(ptr);  // ❌ Libérer deux fois

Corrompt les métadonnées du Heap
→ Exploitation possible
```

## 4. Techniques d'Exploitation

### 4.1 Heap Spraying

```ascii
Remplir le Heap avec du shellcode :

for (i = 0; i < 1000; i++) {
    malloc(4096);
    memcpy(..., shellcode, ...);
}

HEAP après spray :
┌──────────┬──────────┬──────────┐
│SHELLCODE │SHELLCODE │SHELLCODE │
└──────────┴──────────┴──────────┘

Sauter n'importe où → haute chance de tomber sur shellcode
```

## Ressources

- [Heap Exploitation](https://heap-exploitation.dhavalkapil.com/)
- [Malloc Internals](https://sourceware.org/glibc/wiki/MallocInternals)

