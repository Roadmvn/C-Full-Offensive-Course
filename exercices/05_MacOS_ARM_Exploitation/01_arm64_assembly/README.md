# ARM64 Assembly

Apprentissage de l'assembleur ARM64 (AArch64) sur macOS.

## Architecture ARM64

- **64 registres généraux** : X0-X30, SP, PC
- **32 registres FP/SIMD** : V0-V31
- **Registres spéciaux** : X29 (FP), X30 (LR)

## Conventions d'Appel (macOS)

### Arguments
- X0-X7 : 8 premiers arguments
- Stack : arguments supplémentaires

### Retour
- X0 : Valeur de retour

### Préservés
- X19-X28 : Doivent être sauvegardés
- X29 (FP), X30 (LR)

## Syscalls macOS

Numéro dans **X16**, puis `SVC #0x80`.

| Syscall | Numéro | Paramètres |
|---------|--------|------------|
| exit    | 0x2000001 | X0=code |
| read    | 0x2000003 | X0=fd, X1=buf, X2=len |
| write   | 0x2000004 | X0=fd, X1=buf, X2=len |

## Instructions Essentielles

```asm
MOV  X0, #42        // X0 = 42
ADD  X0, X1, X2     // X0 = X1 + X2
SUB  X0, X1, #10    // X0 = X1 - 10
LDR  X0, [X1]       // X0 = *X1
STR  X0, [X1]       // *X1 = X0
B    label          // Branch
BL   func           // Branch with Link (appel)
RET                 // Return
STP  X29, X30, [SP, #-16]!  // Push FP, LR
LDP  X29, X30, [SP], #16    // Pop FP, LR
```

## Exemple Minimal

```asm
.global _main
.align 2

_main:
    mov x0, #42
    ret
```

## Compilation

```bash
# Méthode 1 : clang (recommandé)
clang -o prog prog.s

# Méthode 2 : as + ld
as -o prog.o prog.s
ld -o prog prog.o -lSystem -syslibroot `xcrun -sdk macosx --show-sdk-path` -e _main -arch arm64

# Exécution
./prog
echo $?  # Code de retour
```

## Débogage

```bash
# Désassembler
otool -tv prog

# Débugger
lldb prog
(lldb) b _main
(lldb) run
(lldb) register read
```

## Ressources

- [ARM Architecture Reference Manual](https://developer.arm.com/documentation/)
- [Apple Silicon ABI](https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms)

