⚠️ AVERTISSEMENT STRICT
Techniques de malware development. Usage éducatif uniquement.

EXERCICES - MODULE 37 : REFLECTIVE LOADING

[ ] 1. COMPLETE PE PARSER
Parser complet fichier PE/DLL :
- Parse DOS header (e_magic MZ check)
- Parse NT headers (Signature PE check)
- Enumerate all sections (.text, .data, .rdata)
- Parse Import/Export tables
- Display relocations, TLS callbacks

Référence : PE format Microsoft documentation

[ ] 2. MANUAL IMPORT RESOLUTION
Résoudre imports manuellement :
- Parse IMAGE_IMPORT_DESCRIPTOR array
- LoadLibraryA() each DLL
- GetProcAddress() each function
- Write addresses to IAT (Import Address Table)
- Handle ordinal imports

Référence : IAT hooking techniques

[ ] 3. BASE RELOCATION ENGINE
Implémenter relocations :
- Calculate delta (actual_base - preferred_base)
- Parse IMAGE_BASE_RELOCATION table
- Apply IMAGE_REL_BASED_DIR64 (x64)
- Apply IMAGE_REL_BASED_HIGHLOW (x86)
- Fix all absolute addresses

Référence : PE relocation specifications

[ ] 4. FULL REFLECTIVE DLL LOADER
Charger DLL complètement depuis buffer :
- VirtualAlloc(SizeOfImage)
- Copy headers + sections
- Resolve imports
- Apply relocations
- VirtualProtect set correct permissions
- Call DllMain(DLL_PROCESS_ATTACH)

Référence : Stephen Fewer reflective DLL injection

[ ] 5. SRDI (SHELLCODE REFLECTIVE DLL)
Convert DLL to position-independent shellcode :
- Prepend bootstrap shellcode
- Resolve kernel32 base (PEB walk)
- Find LoadLibraryA/GetProcAddress
- Self-relocate and execute
- No external dependencies

Référence : sRDI project (Monoxgas)

[ ] 6. REMOTE PROCESS INJECTION
Inject reflective DLL into remote process :
- OpenProcess(PROCESS_ALL_ACCESS, pid)
- VirtualAllocEx(MEM_COMMIT | MEM_RESERVE)
- WriteProcessMemory(dll_buffer + loader)
- CreateRemoteThread(loader_entry)
- Wait and cleanup

Référence : Process injection techniques

[ ] 7. MODULE STOMPING
Overwrite legitimate DLL in memory :
- Find loaded module (e.g., ntdll.dll)
- VirtualProtect(PAGE_EXECUTE_READWRITE)
- Overwrite .text section avec payload
- Restore headers/relocations
- Execute malicious code in "legit" module

Référence : Module stomping APT techniques

[ ] 8. ANTI-MEMORY-SCANNING
Éviter détection memory scanners :
- Erase PE headers after load (wipe MZ/PE)
- Encrypt sections when not executing
- Hook NtQueryVirtualMemory
- Return fake module information
- Use sleep obfuscation

Référence : Cobalt Strike sleep mask

NOTES :
- PE-sieve détecte PE headers in anonymous memory
- Moneta scanner trouve IAT hooks
- EDR détecte VirtualAllocEx + WriteProcessMemory
- Sysmon Event 8 (CreateRemoteThread)
- Memory forensics trouve erased headers via reconstruction
