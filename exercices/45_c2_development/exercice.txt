EXERCICES - Module 45 : C2 Development

AVERTISSEMENT LEGAL EXTREME : Developpement C2 malveillant = CRIME FEDERAL GRAVE.
Peines prison 10-20 ans. Ne JAMAIS developper/deployer C2 sans autorisation legale
ECRITE explicite. Exercices THEORIQUES pour comprehension defense et red team AUTORISE.

Difficulte : ★★★★★ (Avance - ILLEGAL sans autorisation)

IMPORTANT : Exercices doivent etre pratiques dans LAB ISOLE uniquement, JAMAIS production.

Exercice 1 : Protocol Design (THEORIQUE/LAB)
[ ] Concevoir protocole C2 custom (format messages)
[ ] Definir structure beacon check-in (metadata: hostname, user, OS)
[ ] Implementer tasking protocol (server -> beacon commands)
[ ] Creer format reponse (beacon -> server output)
[ ] Ajouter versioning protocol (backward compatibility)

Exercice 2 : Encryption Implementation (LAB ISOLE)
[ ] Implementer AES-256-CBC pour chiffrement communications
[ ] Generer cles session uniques par beacon (key exchange)
[ ] Ajouter HMAC pour integrite messages
[ ] Implementer perfect forward secrecy (ephemeral keys)
[ ] Tester resistance decryption (validation crypto)

Exercice 3 : Multi-Protocol Beacon (LAB ISOLE)
[ ] Implementer beacon HTTPS (port 443)
[ ] Ajouter fallback DNS tunneling (si HTTPS bloque)
[ ] Implementer SMB named pipes (lateral movement)
[ ] Creer logique auto-selection protocole optimal
[ ] Tester failover entre protocoles

Exercice 4 : Sleep & Jitter Advanced (LAB ISOLE)
[ ] Implementer sleep randomise (jitter configurable)
[ ] Ajouter working hours only (9AM-5PM beaconing)
[ ] Implementer adaptive sleep (plus long si inactif)
[ ] Creer kill date (beacon self-destruct apres date)
[ ] Tester detection evasion (analyze traffic patterns)

Exercice 5 : Task Queue System (LAB ISOLE)
[ ] Implementer queue commandes cote serveur
[ ] Beacon fetch multiple tasks par callback
[ ] Gerer execution asynchrone (threads)
[ ] Implementer priorities tasks (urgent vs normal)
[ ] Creer system acknowledgment/retry failed tasks

Exercice 6 : Obfuscation & Stealth (LAB ISOLE)
[ ] Implementer domain fronting (Cloudflare, AWS)
[ ] Obfusquer traffic HTTP (mimic Google Analytics, etc.)
[ ] Ajouter User-Agent randomization (legitimate browsers)
[ ] Implementer request/response padding (taille variable)
[ ] Tester contre inspection DPI (Deep Packet Inspection)

Exercice 7 : Persistence Mechanisms (THEORIQUE - BLUE TEAM FOCUS)
[ ] THEORIQUE: Documenter registry run keys
[ ] THEORIQUE: Analyser scheduled tasks persistence
[ ] THEORIQUE: Comprendre WMI event subscriptions
[ ] THEORIQUE: Identifier detection persistence (Sysmon, etc.)
[ ] NE PAS implementer persistence reelle (sauf lab isole)

Exercice 8 : C2 Infrastructure (THEORIQUE/DESIGN)
[ ] Concevoir architecture C2 multi-tiers (redirectors)
[ ] Implementer load balancing beacons (multiple listeners)
[ ] Creer design haute disponibilite (failover servers)
[ ] Documenter OPSEC considerations (IP reputation, etc.)
[ ] Proposer defense evasion strategies (rotation infrastructure)

BONUS CHALLENGES (LAB ISOLE STRICTEMENT)

Challenge 9 : Malleable C2 Profiles
[ ] Implementer Cobalt Strike-like malleable profiles
[ ] Creer profils mimicking legitimate traffic (Office365, Dropbox)
[ ] Customiser HTTP headers/URIs/responses
[ ] Tester detection evasion (JA3 fingerprinting, etc.)
[ ] Valider indistinguishability traffic legitime

Challenge 10 : P2P C2 Architecture
[ ] Implementer peer-to-peer beacons (mesh network)
[ ] Creer beacon parent/child relationships
[ ] Implementer routing commandes via peers
[ ] Ajouter resiliency (perte nœud central)
[ ] Tester scalabilite (100+ beacons)

Challenge 11 : Post-Exploitation Modules
[ ] Creer module credential dumping (LSASS - educational)
[ ] Implementer screenshot capture
[ ] Ajouter keylogger module (demo uniquement)
[ ] Creer module lateral movement (PsExec-like)
[ ] Integrer modules dans C2 framework

OUTILS REFERENCE (ETUDE - NE PAS ABUSER)
- Cobalt Strike : Commercial C2 (license requise)
- Metasploit : Open source framework
- Sliver : Modern Go-based C2
- Covenant : .NET C2 framework
- Mythic : Multi-agent C2 platform

CRITERES VALIDATION (LAB ISOLE)
- Communications chiffrees correctement (AES-256)
- Beacon stable (pas crashes)
- Detection evasion effective (traffic analysis)
- Tasking functional (commands execute correctly)
- USAGE LAB UNIQUEMENT (jamais production/malveillant)

INDICATEURS DETECTION (BLUE TEAM FOCUS)

Network Level:
1. Beaconing patterns (regularity timing)
2. High entropy data (encrypted payloads)
3. Unusual User-Agents ou HTTP headers
4. Connections to suspicious IPs/domains
5. DNS queries long/high-entropy subdomains
6. JA3/JA3S TLS fingerprints suspects
7. Certificate anomalies (self-signed, short validity)

Host Level:
8. Unusual network connections (uncommon processes)
9. Process injection (Sysmon Event ID 8)
10. Suspicious parent-child relationships
11. Command-line obfuscation (base64, etc.)
12. Persistence mechanisms (registry, scheduled tasks)
13. Memory artifacts (strings, IOCs)
14. File drops to temp directories

Behavioral:
15. Data exfiltration patterns (large uploads)
16. Credential access attempts
17. Lateral movement indicators
18. Privilege escalation attempts
19. Anti-forensics activities

DETECTION TECHNIQUES

Network Analysis:
```python
# Pseudo-code beacon detection
def detect_beaconing(traffic_log):
    # Analyser intervalles callbacks
    intervals = calculate_intervals(traffic_log)

    # Regularity check
    if std_dev(intervals) < threshold:
        alert("Potential beaconing detected")

    # Jitter analysis
    jitter = calculate_jitter(intervals)
    if jitter < 30%:  # Low jitter = automated
        alert("Low jitter beaconing")
```

JA3 Fingerprinting:
```bash
# Extraire JA3 hash traffic TLS
ja3 -r capture.pcap | sort | uniq -c

# Comparer avec known-good baseline
# Anomalies = potential C2
```

DNS Analysis:
```python
# Detecter DNS tunneling
def detect_dns_tunneling(dns_queries):
    for query in dns_queries:
        # Check entropy subdomain
        if entropy(query.subdomain) > 4.0:
            alert("High entropy DNS - potential C2")

        # Check length
        if len(query.subdomain) > 40:
            alert("Long subdomain - potential data exfiltration")
```

MITIGATIONS BLUE TEAM

Prevention:
1. Application whitelisting (block unknown executables)
2. Network segmentation (limit outbound connections)
3. Proxy/filtering (block suspicious domains/IPs)
4. TLS inspection (decrypt/analyze HTTPS traffic)
5. DNS filtering (block malicious domains)

Detection:
6. IDS/IPS signatures (known C2 frameworks)
7. EDR behavioral analytics (process relationships)
8. Network traffic analysis (beaconing detection)
9. SIEM correlation rules (multiple IOCs)
10. Threat intelligence feeds (known C2 infrastructure)

Response:
11. Incident response playbook (C2 detection)
12. Automated containment (isolate infected hosts)
13. Threat hunting (proactive search IOCs)
14. Forensic analysis (understand attack scope)
15. Intelligence sharing (ISAC, industry groups)

C2 FRAMEWORKS COMPARISON (RESEARCH)

Cobalt Strike:
- Commercial ($3,500/user/year)
- Malleable C2 profiles
- Extensive post-exploitation
- Most detected by EDR

Metasploit:
- Open source (free)
- Meterpreter payload
- Large module library
- Signatures well-known

Sliver:
- Open source, modern
- Go-based, cross-platform
- Dynamic code generation
- Less detected (newer)

Covenant:
- .NET-based C2
- PowerShell integration
- Web GUI management
- Moderate detection

Custom C2:
- Highest OPSEC (unique signatures)
- Requires development expertise
- Maintenance burden
- Variable detection

ETHICAL CONSIDERATIONS

Legitimate Usage:
1. Red team engagements (AVEC CONTRAT)
2. Penetration testing (AUTORISATION ECRITE)
3. Research academique (IRB approval)
4. Blue team training (LAB ISOLE)
5. Malware analysis (DEFENSE)

ILLEGAL Usage:
- Tout usage sans autorisation ecrite
- Deployment sur reseaux tiers
- Data exfiltration non-autorisee
- Ransomware deployment
- Cyber espionage

Consequences Legales:
- USA: CFAA violation (18 USC § 1030)
  * Up to 20 years prison
  * Fines up to $250,000
- UE: Cybercrime Directive
- International: Budapest Convention

AVERTISSEMENT FINAL

C2 development est competence AVANCEE red team. Utilisation STRICTEMENT limitee:
1. Pentesting contractuel autorise
2. Red team engagements entreprise
3. Research ethique approuvee
4. Blue team defense training (LAB)

NE JAMAIS:
- Deployer C2 sans autorisation legale ECRITE
- Tester sur infrastructure tierce
- Partager C2 avec parties non-autorisees
- Utiliser pour profit personnel illegal

Violation = CRIME GRAVE avec consequences vie-entieres (prison, casier, carriere).

Si vous developpez C2:
- Obtenir autorisation legale AVANT
- Documenter scope engagement
- Respecter limites autorisees
- Reporter findings de maniere responsable
- Detruire infrastructure apres engagement
