⚠️ AVERTISSEMENT STRICT
Techniques de malware development avancées. Usage éducatif uniquement.
Tests sur VM isolées. Usage malveillant = PRISON.

EXERCICES - MODULE 22 : DIRECT SYSCALLS

[ ] 1. HELL'S GATE COMPLET
Implémenter Hell's Gate pour extraire les SSN de 10 fonctions NTAPI :
- NtAllocateVirtualMemory
- NtProtectVirtualMemory
- NtWriteVirtualMemory
- NtCreateThreadEx
- NtQueueApcThread
- NtOpenProcess
- NtReadVirtualMemory
- NtResumeThread
- NtGetContextThread
- NtSetContextThread

Techniques : Pattern matching sur opcodes, parsing PE export table
Référence : Hell's Gate paper (VX-Underground), maldev.academy

[ ] 2. HALO'S GATE AVEC DÉTECTION HOOKS
Créer un système de détection de hooks avancé :
- Détecter hooks inline (JMP, CALL)
- Détecter hooks IAT (Import Address Table)
- Chercher dans un rayon de ±50 fonctions pour SSN voisins
- Calculer SSN par interpolation si plusieurs voisins trouvés
- Logger toutes les fonctions hookées détectées

Techniques : Opcode analysis, neighbor scanning, SSN calculation
Référence : Halo's Gate paper, EDR hook detection techniques

[ ] 3. SYSCALL WRAPPER GÉNÉRIQUE
Développer un wrapper syscall universel :
- Support jusqu'à 10 arguments (x64 calling convention)
- Gestion automatique du stack pour args 5+
- Macro pour définir facilement de nouveaux syscalls
- Error handling avec NTSTATUS codes

Exemple usage :
SYSCALL_DEFINE(NtAllocateVirtualMemory, 6);
SYSCALL_INVOKE(NtAllocateVirtualMemory, handle, &base, ...);

Techniques : Inline ASM, variadic macros, x64 ABI
Référence : MSDN x64 calling convention, SysWhispers project

[ ] 4. FRESH NTDLL MAPPING
Charger une copie propre de ntdll.dll depuis disk :
- CreateFileMapping pour mapper ntdll.dll en mémoire
- Parser PE headers pour trouver .text section
- Comparer avec ntdll.dll en mémoire (détection hooks)
- Extraire tous les SSN depuis la copie propre
- Alternative : télécharger ntdll.dll depuis Windows Update

Techniques : PE parsing, file mapping, memory comparison
Référence : Perun's Fart technique, malware unhooking

[ ] 5. ETW PATCHING VIA SYSCALL
Désactiver Event Tracing for Windows (ETW) :
- Utiliser syscall direct pour patcher EtwEventWrite
- Technique : NtProtectVirtualMemory pour RWX puis patch avec 'ret'
- Tester avec Process Monitor (devrait ne plus voir events)
- Bonus : Patcher aussi AMSI (AmsiScanBuffer)

Techniques : Memory patching, ETW/AMSI internals, syscall usage
Référence : Red Team Operator course, AMSI bypass techniques

[ ] 6. NTDLL UNHOOKING COMPLET
Restaurer ntdll.dll hookée par un EDR :
- Mapper clean ntdll depuis disk
- Identifier toutes les fonctions hookées (comparaison bytes)
- Restaurer les opcodes originaux via NtWriteVirtualMemory (syscall)
- Flush instruction cache (NtFlushInstructionCache)

Techniques : Memory restoration, EDR evasion, syscall-based patching
Référence : EDR unhooking techniques, SylantStrike project

[ ] 7. INDIRECT SYSCALLS
Technique avancée pour éviter détection de syscall instruction :
- Au lieu de 'syscall' direct, jump vers ntdll's syscall stub
- Utiliser ROP gadget : JMP [ntdll!NtAllocateVirtualMemory+X]
- Spoofing de return address pour simuler appel légitime
- Contourne les EDRs qui détectent syscall hors ntdll

Techniques : Return address spoofing, ROP gadgets, call stack manipulation
Référence : Indirect syscalls (MDSec blog), call stack spoofing

[ ] 8. SYSCALL SYSWHISPERS CLONE
Créer un générateur de syscall stubs (comme SysWhispers2) :
- Parser ntdll.dll pour extraire tous les exports Nt*/Zw*
- Générer header (.h) avec prototypes NTAPI
- Générer ASM stubs (.asm) avec SSN hardcodés pour version Windows
- Script Python pour automatiser la génération

Techniques : PE parsing automation, ASM code generation, build automation
Référence : SysWhispers2 (GitHub), syscall number database

DOCUMENTATION :
- Windows Internals (Russinovich) - Chapitres sur System Calls
- NTAPI Undocumented Functions (ntdoc.m417z.com)
- VX-Underground papers (Hell's Gate, Halo's Gate)
- MDSec Blog (Syscall techniques)

NOTES :
- SSN changent entre versions Windows (19H1, 20H2, 21H1, etc.)
- Testez sur Windows 10 build 19041+ et Windows 11
- EDRs modernes détectent syscalls : utilisez indirect syscalls
- Combinez avec obfuscation et anti-debug pour max stealth
