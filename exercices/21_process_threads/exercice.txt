⚠️ AVERTISSEMENT STRICT
Techniques de malware development avancées. Usage éducatif uniquement.
Tests sur VM isolées. Usage malveillant = PRISON.

EXERCICES - MODULE 21 : PROCESS & THREADS

[ ] 1. C2 BEACON MULTI-CLIENT
Créer un serveur C2 qui gère 10+ beacons simultanés via thread pool.
Chaque beacon doit :
- Envoyer heartbeat toutes les 5 secondes
- Recevoir et exécuter des commandes (sleep, download, execute)
- Gérer la reconnexion automatique en cas de déconnexion

Techniques : pthread_create() ou CreateThread(), select()/poll() pour I/O multiplexing
Référence : Cobalt Strike Team Server, Metasploit multi/handler

[ ] 2. PROCESS MIGRATION
Implémenter la migration de payload d'un processus à un autre :
- Énumérer les processus cibles (ex: explorer.exe, svchost.exe)
- Injecter le payload dans le processus cible via CreateRemoteThread
- Terminer le processus original proprement

Techniques : CreateToolhelp32Snapshot, VirtualAllocEx, WriteProcessMemory
Référence : Meterpreter migrate, Cobalt Strike spawn+inject

[ ] 3. FORK BOMB PROTECTION
Créer un payload qui spawn des processus enfants mais :
- Limite le nombre total de processus (max 5)
- Tue les processus zombies automatiquement
- Implémente un mécanisme de process pooling réutilisable

Techniques : fork(), waitpid(WNOHANG), process counting via /proc
Référence : APT malware avec rate limiting anti-detection

[ ] 4. IPC COVERT CHANNEL
Implémenter un canal de communication caché entre 2 processus :
- Utiliser shared memory (shm_open/mmap) pour éviter syscalls réseau
- Chiffrer les données échangées (XOR minimum)
- Implémenter un protocole simple (command ID + payload)

Techniques : POSIX shared memory, semaphores pour sync, encoding
Référence : Equation Group DanderSpritz, NSA implants

[ ] 5. THREAD INJECTION LOCALE
Créer un thread dans votre propre processus qui exécute du shellcode :
- Allouer une région RWX (VirtualAlloc avec PAGE_EXECUTE_READWRITE)
- Copier le shellcode en mémoire
- Créer un thread pointant vers le shellcode
- Bonus : passer de RW à RX après copie (VirtualProtect)

Techniques : VirtualAlloc, CreateThread, shellcode execution
Référence : Self-injection technique, in-memory payload staging

[ ] 6. DAEMON/SERVICE BACKGROUNDING
Transformer votre payload en daemon (Linux) ou service (Windows) :
- Linux : double fork + setsid() pour détachement total
- Windows : CreateProcess avec DETACHED_PROCESS flag
- Rediriger stdout/stderr vers /dev/null ou NUL
- Écrire un PID file pour tracking

Techniques : daemon(3), setsid(), file descriptor redirection
Référence : Persistence mechanisms, rootkit techniques

[ ] 7. THREAD POOL AVEC WORK QUEUE
Implémenter un thread pool avancé :
- Queue de travail thread-safe (producer-consumer pattern)
- Threads qui attendent des tâches (condition variables)
- Ajout dynamique de tâches (exécution shellcode, exfil, scan réseau)
- Arrêt propre de tous les threads via poison pill

Techniques : pthread_cond_wait, mutex, circular buffer
Référence : Malware modulaire (Emotet, TrickBot), C2 task scheduling

[ ] 8. PROCESS HOLLOWING (RunPE)
Technique avancée d'injection :
- Créer un processus légitime en mode SUSPENDED
- Vider (hollow) sa mémoire avec NtUnmapViewOfSection
- Injecter votre payload à l'adresse base du PE original
- Fixer le contexte (EIP/RIP) et reprendre le thread

Techniques : CreateProcess(CREATE_SUSPENDED), NtUnmapViewOfSection,
             SetThreadContext, ResumeThread
Référence : Process Hollowing (APT groups), RunPE technique

DOCUMENTATION :
- MSDN : Process and Thread Functions
- Linux : man pthread, man fork, man mmap
- Cobalt Strike documentation (Beacon architecture)
- Metasploit Framework source code (meterpreter)

NOTES :
- Testez sur VMs Windows 10/11 ET Linux (Ubuntu/Kali)
- Utilisez Sysmon + ProcessHacker pour observer vos créations
- EDRs détectent CreateRemoteThread : essayez QueueUserAPC comme alternative
- Pour bypass : utilisez des processus légitimes (svchost, explorer, dllhost)
